<form
  action="/settings/<%= branchId %>"
  method="GET"
  class="content-form flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-700 hover:bg-opacity-50 text-gray-300 hover:text-white transition-all cursor-pointer"
>
  <button
    onclick="loadSettings(event)"
    type="submit"
    class="flex items-center space-x-3 w-full text-left"
  >
    <svg
      class="w-5 h-5 flex-shrink-0"
      xmlns="http://www.w3.org/2000/svg"
      fill="currentColor"
      viewBox="0 0 20 20"
    >
      <path
        d="M11.3 1.046a1 1 0 00-2.6 0l-.2.802a1 1 0 01-.8.727 8.058 8.058 0 00-1.517.505 1 1 0 01-1.09-.243l-.57-.57a1 1 0 00-1.414 0l-1.06 1.06a1 1 0 000 1.414l.57.57a1 1 0 01.243 1.09 8.058 8.058 0 00-.505 1.517 1 1 0 01-.727.8l-.802.2a1 1 0 000 2.6l.802.2a1 1 0 01.727.8c.095.53.27 1.039.505 1.517a1 1 0 01-.243 1.09l-.57.57a1 1 0 000 1.414l1.06 1.06a1 1 0 001.414 0l.57-.57a1 1 0 011.09-.243c.478.235.986.41 1.517.505a1 1 0 01.8.727l.2.802a1 1 0 002.6 0l.2-.802a1 1 0 01.8-.727 8.058 8.058 0 001.517-.505 1 1 0 011.09.243l.57.57a1 1 0 001.414 0l1.06-1.06a1 1 0 000-1.414l-.57-.57a1 1 0 01-.243-1.09c.235-.478.41-.986.505-1.517a1 1 0 01.727-.8l.802-.2a1 1 0 000-2.6l-.802-.2a1 1 0 01-.727-.8 8.058 8.058 0 00-.505-1.517 1 1 0 01.243-1.09l.57-.57a1 1 0 000-1.414l-1.06-1.06a1 1 0 00-1.414 0l-.57.57a1 1 0 01-1.09.243 8.058 8.058 0 00-1.517-.505 1 1 0 01-.8-.727l-.2-.802zM10 13a3 3 0 110-6 3 3 0 010 6z"
      />
    </svg>
    <span class="font-semibold text-sm sm:text-base">Settings</span>
  </button>
</form>

<script>
  async function loadSettings(event) {
    event.preventDefault();
    try {
      const response = await fetch("/dashboard/<%= branchId %>/settings");
      const html = await response.text();

      // Load the settings content into the dashboard-content div
      document.getElementById("dashboard-content").innerHTML = html;
    } catch (error) {
      console.error("Error loading settings:", error);
    }
  }
</script>

<script>
  // Tab Management
  function showTab(tabName) {
    document.querySelectorAll(".settings-content").forEach((content) => {
      content.classList.add("hidden");
    });

    document.querySelectorAll(".settings-tab").forEach((tab) => {
      tab.classList.remove("border-orange-500", "text-orange-600");
      tab.classList.add("border-transparent", "text-gray-500");
    });

    document.getElementById(tabName).classList.remove("hidden");

    const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
    activeTab.classList.add("border-orange-500", "text-orange-600");
    activeTab.classList.remove("border-transparent", "text-gray-500");
  }

  // Payment Gateway Tab Management
  function showPaymentTab(tabName) {
    document.querySelectorAll(".payment-content").forEach((content) => {
      content.classList.add("hidden");
    });

    document.querySelectorAll(".payment-tab").forEach((tab) => {
      tab.classList.remove("border-orange-500", "text-orange-600");
      tab.classList.add("border-transparent", "text-gray-500");
    });

    document.getElementById(tabName).classList.remove("hidden");

    const activeTab = document.querySelector(`[data-payment-tab="${tabName}"]`);
    activeTab.classList.add("border-orange-500", "text-orange-600");
    activeTab.classList.remove("border-transparent", "text-gray-500");
  }

  // Modal Functions - Branch
  function openAddBranchModal() {
    document.getElementById("addBranchModal").classList.remove("hidden");
  }

  function closeAddBranchModal() {
    document.getElementById("addBranchModal").classList.add("hidden");
  }

  function openEditBranchModal(id, name, address) {
    document.getElementById("editBranchName").value = name;
    document.getElementById("editBranchAddress").value = address;
    document.getElementById(
      "editBranchForm"
    ).action = `/dashboard/<%= branchId %>/settings/branch/${id}?_method=PUT`;
    document.getElementById("editBranchModal").classList.remove("hidden");
  }

  function closeEditBranchModal() {
    document.getElementById("editBranchModal").classList.add("hidden");
  }

  // Modal Functions - Currency
  function openAddCurrencyModal() {
    document.getElementById("addCurrencyModal").classList.remove("hidden");
  }

  function closeAddCurrencyModal() {
    document.getElementById("addCurrencyModal").classList.add("hidden");
  }

  function openEditCurrencyModal(id, name, symbol, code) {
    document.getElementById("editCurrencyName").value = name;
    document.getElementById("editCurrencySymbol").value = symbol;
    document.getElementById("editCurrencyCode").value = code;
    document.getElementById(
      "editCurrencyForm"
    ).action = `/dashboard/<%= branchId %>/settings/currency/${id}?_method=PUT`;
    document.getElementById("editCurrencyModal").classList.remove("hidden");
  }

  function closeEditCurrencyModal() {
    document.getElementById("editCurrencyModal").classList.add("hidden");
  }

  // Modal Functions - Tax
  function openAddTaxModal() {
    document.getElementById("addTaxModal").classList.remove("hidden");
  }

  function closeAddTaxModal() {
    document.getElementById("addTaxModal").classList.add("hidden");
  }

  function openEditTaxModal(id, name, percentage) {
    document.getElementById("editTaxName").value = name;
    document.getElementById("editTaxPercentage").value = percentage;
    document.getElementById(
      "editTaxForm"
    ).action = `/dashboard/<%= branchId %>/settings/tax/${id}?_method=PUT`;
    document.getElementById("editTaxModal").classList.remove("hidden");
  }

  function closeEditTaxModal() {
    document.getElementById("editTaxModal").classList.add("hidden");
  }

  // Close modals when clicking outside
  window.onclick = function (event) {
    const modals = [
      "addBranchModal",
      "editBranchModal",
      "addCurrencyModal",
      "editCurrencyModal",
      "addTaxModal",
      "editTaxModal",
    ];
    modals.forEach((modalId) => {
      const modal = document.getElementById(modalId);
      if (event.target === modal) {
        modal.classList.add("hidden");
      }
    });
  };
</script>

<!-- settings -->

<script>
  document.addEventListener("change", async (e) => {
    if (e.target.classList.contains("permission-toggle")) {
      const checkbox = e.target;
      const role = checkbox.dataset.role;
      const section = checkbox.dataset.section;
      const action = checkbox.dataset.action;
      const value = checkbox.checked;

      const slider = checkbox.nextElementSibling;
      const knob = slider.querySelector("div");

      // âœ… Instant UI feedback
      slider.classList.toggle("bg-green-500", value);
      slider.classList.toggle("bg-gray-300", !value);
      knob.classList.toggle("translate-x-5", value);

      try {
        const res = await fetch(
          `/dashboard/<%= branchId %>/settings/permissions/update`,
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ role, section, action, value }),
          }
        );

        const data = await res.json();

        if (data.success) {
          showToast(`Updated ${action} permission for ${role}`);
        } else {
          //revert toggle if update fails
          checkbox.checked = !value;
          slider.classList.toggle("bg-green-500", !value);
          slider.classList.toggle("bg-gray-300", value);
          knob.classList.toggle("translate-x-5", !value);
          showToast(`${data.message || "Failed to update permission"}`, true);
        }
      } catch (err) {
        console.error("Permission update failed", err);
        // revert on error
        checkbox.checked = !value;
        slider.classList.toggle("bg-green-500", !value);
        slider.classList.toggle("bg-gray-300", value);
        knob.classList.toggle("translate-x-5", !value);
        showToast("Error updating permission!", true);
      }
    }
  });

  //Toast notification
  function showToast(message, isError = false) {
    const toast = document.createElement("div");
    toast.textContent = message;
    toast.className = `
      fixed bottom-6 right-6 z-50 px-4 py-3 rounded-lg shadow-lg text-white font-medium
      ${isError ? "bg-red-600" : "bg-green-600"}
      animate-fadeInOut
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2500);
  }

  //Simple fade animation
  const style = document.createElement("style");
  style.innerHTML = `
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(10px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(10px); }
    }
    .animate-fadeInOut { animation: fadeInOut 2.5s ease forwards; }
  `;
  document.head.appendChild(style);
</script>

<!-- Billing Tab Script -->
<script>
  function switchTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll(".tab-content").forEach((content) => {
      content.classList.add("hidden");
    });

    // Remove active state from all tabs
    document.querySelectorAll(".tab-button").forEach((button) => {
      button.classList.remove("border-orange-500", "text-orange-600");
      button.classList.add("border-transparent", "text-gray-500");
    });

    // Show selected tab content
    document.getElementById("content-" + tabName).classList.remove("hidden");

    // Add active state to clicked tab
    const activeTab = document.getElementById("tab-" + tabName);
    activeTab.classList.remove("border-transparent", "text-gray-500");
    activeTab.classList.add("border-orange-500", "text-orange-600");
  }

  function viewOfflineRequest(requestId) {
    window.location.href = `/offline-request/${requestId}`;
  }

  function deleteOfflineRequest(requestId) {
    if (confirm("Are you sure you want to delete this request?")) {
      fetch(
        `/dashboard/<%= branchId %>/settings/billing/offline-request/${requestId}`,
        {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        }
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.success) {
            location.reload();
          } else {
            alert("Failed to delete request");
          }
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("An error occurred");
        });
    }
  }
</script>

<!-- reservation-settings -->
<script>
  function switchDay(dayName) {
    // Hide all day contents
    document.querySelectorAll(".day-content").forEach((content) => {
      content.classList.add("hidden");
    });

    // Remove active state from all day buttons
    document.querySelectorAll(".day-btn").forEach((button) => {
      button.classList.remove("bg-orange-500", "text-white");
      button.classList.add(
        "bg-white",
        "text-gray-700",
        "border",
        "border-gray-300"
      );
    });

    // Show selected day content
    document.getElementById("content-" + dayName).classList.remove("hidden");

    // Add active state to clicked day button
    const activeBtn = document.getElementById("day-btn-" + dayName);
    activeBtn.classList.remove(
      "bg-white",
      "text-gray-700",
      "border",
      "border-gray-300"
    );
    activeBtn.classList.add("bg-orange-500", "text-white");
  }
</script>

<!-- about us -->
<script>
  // Initialize About Us editor when DOM is ready
  document.addEventListener("DOMContentLoaded", function () {
    initializeAboutUsEditor();
  });

  function initializeAboutUsEditor() {
    const editor = document.getElementById("aboutUsEditor");
    const hiddenInput = document.getElementById("aboutUsContent");
    const charCount = document.getElementById("charCount");

    // Skip if elements don't exist (user might not be on About Us tab)
    if (!editor || !hiddenInput || !charCount) return;

    // Format text function
    window.formatText = function (command, value = null) {
      if (command === "createLink") {
        const url = prompt("Enter the URL:");
        if (url) {
          document.execCommand("createLink", false, url);
        }
      } else if (command === "fontSize") {
        const size = prompt("Enter font size (1-7):", "3");
        if (size && size >= 1 && size <= 7) {
          document.execCommand("fontSize", false, size);
        }
      } else {
        document.execCommand(command, false, value);
      }
      editor.focus();
    };

    // Insert emoji
    window.insertEmoji = function (emoji) {
      document.execCommand("insertText", false, emoji);
      editor.focus();
    };

    // Update character count
    function updateCharCount() {
      const text = editor.innerText || editor.textContent;
      charCount.textContent = `${text.length} characters`;
    }

    // Listen for input changes
    editor.addEventListener("input", updateCharCount);
    editor.addEventListener("paste", function (e) {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData(
        "text/plain"
      );
      document.execCommand("insertText", false, text);
    });

    // Initial character count
    updateCharCount();

    // Before form submission, copy editor content to hidden input
    const form = editor.closest("form");
    if (form) {
      form.addEventListener("submit", function (e) {
        hiddenInput.value = editor.innerHTML;
      });
    }
  }

  // Re-initialize when switching to About Us tab
  const originalShowTab = window.showTab;
  window.showTab = function (tabName) {
    if (originalShowTab) originalShowTab(tabName);
    if (tabName === "About-Us") {
      // Small delay to ensure DOM is ready
      setTimeout(initializeAboutUsEditor, 100);
    }
  };
</script>
