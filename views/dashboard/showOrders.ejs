<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Orders Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>

<body class="bg-gray-50 text-gray-900">
  <div class="max-w-7xl mx-auto px-2 py-2">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-semibold text-gray-800">
        Orders (<%= orders.length %>)
      </h1>
      <button
        class="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2.5 rounded-lg font-semibold shadow-md flex items-center gap-2 transition"
        onclick="loadDashboardContent('/pos/<%= branchId %>')">
        <i class="fa fa-plus"></i> New Order
      </button>
    </div>

    <!-- Filters -->
    <form id="filterForm" method="GET" data-branch-id="<%= branchId %>" class="flex flex-wrap gap-3 mb-8">
      <!-- Date Filter -->
      <select name="dateFilter" id="dateFilter" class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm">
        <option value="today" <%=dateFilter==='today' ? 'selected' : '' %>>Today</option>
        <option value="yesterday" <%=dateFilter==='yesterday' ? 'selected' : '' %>>Yesterday</option>
        <option value="week" <%=dateFilter==='week' ? 'selected' : '' %>>This Week</option>
        <option value="month" <%=dateFilter==='month' ? 'selected' : '' %>>This Month</option>
        <option value="custom" <%=dateFilter==='custom' ? 'selected' : '' %>>Custom Range</option>
      </select>

      <!-- Custom Date Range -->
      <div id="customDateContainer" class="flex items-center gap-2 <%= dateFilter === 'custom' ? '' : 'hidden' %>">
        <input type="date" name="startDate" id="startDate" value="<%= startDate || '' %>"
          class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" />
        <span class="text-gray-500">to</span>
        <input type="date" name="endDate" id="endDate" value="<%= endDate || '' %>"
          class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm" />
      </div>

      <!-- Status Filter -->
      <select name="statusFilter" id="statusFilter"
        class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm">
        <option value="all" <%=statusFilter==='all' ? 'selected' : '' %>>All Status</option>
        <% ["KOT", "Billed" , "Paid" , "Payment Due" , "Out For Delivery" , "Delivered" , "Cancelled" ].forEach(status=>
          { %>
          <option value="<%= status %>" <%=statusFilter===status ? 'selected' : '' %>><%= status %>
          </option>
          <% }); %>
      </select>

      <!-- Order Type -->
      <select name="orderType" id="orderType" class="px-4 py-2 border border-gray-300 rounded-lg bg-white text-sm">
        <option value="all" <%=orderType==='all' ? 'selected' : '' %>>All Types</option>
        <% ["Dine In", "Delivery" , "Pickup" ].forEach(type=> { %>
          <option value="<%= type %>" <%=orderType===type ? 'selected' : '' %>><%= type %>
          </option>
          <% }); %>
      </select>
    </form>

    <!-- Orders Section -->
    <div id="ordersContainer">
      <% if (orders.length===0) { %>
        <div class="text-center py-20 text-gray-500 text-lg">
          No orders found for the selected filters.
        </div>
        <% } else { %>
          <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <% orders.forEach(order=> { %>
              <div class="bg-white rounded-xl p-5 shadow-md hover:shadow-lg transition cursor-pointer order-card"
                data-order-id="<%= order._id %>" data-branch-id="<%= branchId %>">
                <!-- Order Header -->
                <div class="flex items-center gap-3 mb-4">
                  <div
                    class="w-12 h-12 bg-orange-100 text-orange-500 rounded-lg flex items-center justify-center text-lg">
                    <i class="fas fa-receipt"></i>
                  </div>
                  <div class="flex-1">
                    <div class="flex items-center gap-2 flex-wrap">
                      <span class="font-semibold text-gray-800">
                        Order #<%= order.orderNumber %>
                      </span>
                      <!-- Table Badge (shown if table is assigned) -->
                      <% if (order.table && order.table.tableCode) { %>
                        <span
                          class="inline-flex items-center gap-1 bg-teal-100 text-teal-700 px-2 py-0.5 rounded text-xs font-semibold">
                          <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                          <%= order.table.tableCode %>
                        </span>
                        <% } %>
                    </div>

                    <% let labelClass="bg-gray-100 text-gray-700" ; let labelText=order.status; switch (order.status) {
                      case "KOT" : labelClass="bg-yellow-100 text-yellow-700" ; labelText="KOT Generated" ; break;
                      case "Billed" : labelClass="bg-blue-100 text-blue-700" ; labelText=order.paymentStatus==="Unpaid"
                      ? "Awaiting Payment" : "Billed" ; break; case "Paid" : labelClass="bg-green-100 text-green-700" ;
                      labelText="Paid" ; break; case "Out For Delivery" : labelClass="bg-purple-100 text-purple-700" ;
                      break; case "Delivered" : labelClass="bg-green-100 text-green-700" ; break; case "Payment Due" :
                      labelClass="bg-orange-100 text-orange-700" ; break; case "Cancelled" :
                      labelClass="bg-red-100 text-red-700" ; break; } %>

                      <span
                        class="inline-flex items-center gap-1.5 text-xs font-medium px-3 py-1 rounded-full <%= labelClass %> mt-1">
                        <span class="w-2 h-2 rounded-full bg-current"></span>
                        <%= labelText %>
                      </span>
                  </div>
                </div>

                <!-- Order Info -->
                <div class="flex justify-between items-center border-b border-gray-100 pb-3 mb-3 text-sm text-gray-600">
                  <div>
                    <%= new Date(order.createdAt).toLocaleDateString('en-US', { month: 'short' , day: 'numeric' }) %>
                      ·
                      <%= new Date(order.createdAt).toLocaleTimeString('en-US', { hour: 'numeric' , minute: '2-digit' ,
                        hour12: true }) %>
                  </div>
                  <div>
                    <%= order.items.length %>
                      <%= order.kotGenerated ? 'KOT' : 'Item(s)' %>
                  </div>
                </div>

                <!-- Footer -->
                <div class="flex justify-between items-center mb-3">
                  <div class="text-lg font-semibold text-gray-800">
                    ₹<%= order.totalAmount.toFixed(2) %>
                  </div>
                  <div class="text-sm text-gray-500 flex items-center gap-2">
                    <i class="fas fa-user"></i>
                    <%= order.customer?.name || 'Walk-in Customer' %>
                  </div>
                </div>

                <!-- Order Type + Payment -->
                <div class="flex justify-between items-center text-xs text-gray-600 pt-3 border-t border-gray-100">
                  <span class="flex items-center gap-1">
                    <% if (order.orderType==='Dine In' ) { %>
                      <i class="fa fa-utensils text-orange-500"></i>
                      <% } else if (order.orderType==='Delivery' ) { %>
                        <i class="fa fa-motorcycle text-blue-500"></i>
                        <% } else if (order.orderType==='Pickup' ) { %>
                          <i class="fa fa-shopping-bag text-green-500"></i>
                          <% } %>
                            <%= order.orderType %>
                  </span>
                  <span class="flex items-center gap-1">
                    <i class="fa fa-credit-card"></i>
                    <%= order.paymentMethod || '—' %>
                      (<%= order.paymentStatus %>)
                  </span>
                </div>
              </div>
              <% }); %>
          </div>
          <% } %>
    </div>
  </div>
</body>

</html>